# GitHub Action to automatically sync types to credovo-webapp
# Runs when shared/types/index.ts changes

name: Sync Types to Webapp

on:
  push:
    paths:
      - 'shared/types/index.ts'
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

jobs:
  sync-types:
    runs-on: ubuntu-latest
    # Don't fail the workflow (and send emails) on errors
    # This is an automated sync, failures can be handled manually
    continue-on-error: true
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout credovo-platform
        uses: actions/checkout@v4
        with:
          path: credovo-platform
      
      - name: Checkout credovo-webapp
        uses: actions/checkout@v4
        with:
          repository: AmanorsElliot/credovo-webapp
          path: credovo-webapp
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Copy types file
        run: |
          mkdir -p credovo-webapp/src/types
          cp credovo-platform/shared/types/index.ts credovo-webapp/src/types/shared-types.ts
      
      - name: Check for changes
        id: check-changes
        run: |
          cd credovo-webapp
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit and push changes
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          cd credovo-webapp
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add src/types/shared-types.ts
          git commit -m "chore: sync shared types from credovo-platform

          Auto-synced from credovo-platform/shared/types/index.ts
          Commit: ${{ github.sha }}"
          git push
      
      - name: Create Pull Request
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: AmanorsElliot/credovo-webapp
          path: credovo-webapp
          branch: sync-shared-types
          title: "chore: Sync shared types from credovo-platform"
          body: |
            Auto-synced shared types from credovo-platform.
            
            Source: `shared/types/index.ts`
            Commit: ${{ github.sha }}
            
            Review and merge to update types in webapp.

